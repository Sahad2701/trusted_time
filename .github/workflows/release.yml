name: Release and Publish

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump strategy (patch, minor, major, manual)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - manual
      manual_version:
        description: 'Manual version string (only used if bump_type is manual)'
        required: false
        type: string

permissions:
  contents: write
  id-token: write # Required for pub.dev OIDC publishing

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: Analyze project
        run: flutter analyze --fatal-infos

      - name: Run tests
        run: flutter test

  release:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to get all tags

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump Version and Generate Notes
        id: versioning
        run: |
          set -ex # Exit on error, print commands

          echo "--- Starting Version Bump and Changelog Generation ---"
          
          # 1. GET CURRENT AND LAST VERSION
          echo "Reading current version from pubspec.yaml..."
          current_version=$(grep '^version: ' pubspec.yaml | sed 's/version: //')
          echo "Current version from pubspec.yaml: $current_version"
          
          echo "Finding last git tag..."
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null)
          if [ -z "$last_tag" ]; then
            echo "No previous tag found."
          else
            echo "Found last tag: $last_tag"
          fi
          
          # 2. CALCULATE NEW VERSION
          echo "Calculating new version based on bump type: ${{ github.event.inputs.bump_type }}"
          if [ "${{ github.event.inputs.bump_type }}" == "manual" ]; then
            if [ -z "${{ github.event.inputs.manual_version }}" ]; then
              echo "Error: 'manual_version' is required for manual bump."
              exit 1
            fi
            new_version="${{ github.event.inputs.manual_version }}"
          else
            IFS='.' read -r -a parts <<< "$current_version"
            major=${parts[0]}
            minor=${parts[1]}
            patch=${parts[2]}
            echo "Parsed version parts: major=$major, minor=$minor, patch=$patch"

            case "${{ github.event.inputs.bump_type }}" in
              "patch") patch=$((patch + 1));;
              "minor") minor=$((minor + 1)); patch=0;;
              "major") major=$((major + 1)); minor=0; patch=0;;
            esac
            new_version="$major.$minor.$patch"
          fi
          echo "Bumping version from $current_version to $new_version"
          echo "NEW_VERSION=$new_version" >> $GITHUB_ENV

          # 3. UPDATE pubspec.yaml
          echo "--- Updating pubspec.yaml ---"
          echo "Content before update:"
          cat pubspec.yaml
          sed -i "s/^version: .*/version: $new_version/" pubspec.yaml
          echo "Content after update:"
          cat pubspec.yaml
          echo "----------------------------"
          
          # 4. GENERATE RELEASE NOTES (handles initial release)
          echo "--- Generating Release Notes ---"
          if [ -z "$last_tag" ]; then
            echo "No previous tag found. Generating changelog for initial release."
            echo "Initial release" > RELEASE_NOTES_TMP.md
            git log --pretty=format:"* %s (%h)" >> RELEASE_NOTES_TMP.md
          else
            echo "Found last tag: $last_tag. Generating changelog from ${last_tag}..HEAD."
            echo "Changes since $last_tag" > RELEASE_NOTES_TMP.md
            git log ${last_tag}..HEAD --pretty=format:"* %s (%h)" >> RELEASE_NOTES_TMP.md
          fi
          echo "--- Generated Release Notes (RELEASE_NOTES_TMP.md) ---"
          cat RELEASE_NOTES_TMP.md
          echo "----------------------------------------------------"

          # 5. UPDATE CHANGELOG.md (or create it)
          echo "--- Updating CHANGELOG.md ---"
          touch CHANGELOG.md
          echo "Content before update:"
          cat CHANGELOG.md
          {
            echo "## [$new_version] - $(date +'%Y-%m-%d')"
            echo ""
            cat RELEASE_NOTES_TMP.md
            echo ""
            cat CHANGELOG.md
          } > CHANGELOG.tmp
          mv CHANGELOG.tmp CHANGELOG.md
          echo "Content after update:"
          cat CHANGELOG.md
          echo "----------------------------"

      - name: Commit and Push Changes
        run: |
          set -ex # Exit on error, print commands

          echo "--- Committing and Pushing Changes ---"
          echo "Staging files: pubspec.yaml, CHANGELOG.md"
          git add pubspec.yaml CHANGELOG.md
          
          echo "Showing staged changes:"
          git diff --staged

          echo "Committing with message: chore(release): bump version to ${{ env.NEW_VERSION }}"
          git commit -m "chore(release): bump version to ${{ env.NEW_VERSION }}"
          
          echo "Creating git tag: v${{ env.NEW_VERSION }}"
          git tag v${{ env.NEW_VERSION }}
          
          echo "Pushing commit and tags to origin main..."
          git push origin main --tags

      - name: Publish to pub.dev
        uses: dart-lang/setup-dart@v1
        with:
          # This enables trusted publishing and runs `dart pub publish --force`
          publish-to-pub-dev: true
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION }}
          body_path: RELEASE_NOTES_TMP.md
          name: TrustedTime v${{ env.NEW_VERSION }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
